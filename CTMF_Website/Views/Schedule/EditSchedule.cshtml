@model System.Data.DataTable
@{
	bool isDayOn = ViewBag.isDayOn;
	ViewBag.Title = "ListSchedule";
}
<link href="~/CSS/table.css" rel="stylesheet" />
<script type="text/javascript">
	$(document).ready(function () {
		fillMealSetDdl($('#meal-set-ddl'));
		setCheckBoxEvent();
	});

	var mealSetVar = null;
	function fillMealSetDdl($ddl) {
		if (mealSetVar == null) {
			$.ajax({
				url: '/Schedule/GetMeatSetForDDL',
				tranditional: true,
				async: false,
				success: function (data) {
					if (data == 'error') {
						alert('Có lỗi khi lấy dữ liệu.');
						return false;
					}

					mealSetVar = data.mealSet;
				}
			});
		}

		for (i = 0; i < mealSetVar.length; i++) {
			$ddl.append($('<option></option>').attr('value', mealSetVar[i].MealSetID).text(mealSetVar[i].Name));
		}
	}

	function addScheduleMealSet() {
		var $mealSetDdl = $('#meal-set-ddl');
		var scheduleID = '@ViewBag.scheduleID';

		var isDayOn = false;
		if ($('#cbIsDayOn').is(':checked')) {
			isDayOn = true;
		}

		$.ajax({
			url: '/Schedule/AddScheduleMealSet',
			tranditional: true,
			data: { mealSetID: parseInt($mealSetDdl.val().toString()), scheduleID: parseInt(scheduleID.toString()), isDayOn: isDayOn },
			async: false,
			success: function (result) {
				if (result == 'error') {
					alert('Có lỗi khi thêm thực đơn.');
					return false;
				}

				if (result.result == 'done') {
					location.reload(false);
				}
			}
		});
	}

	function removeMealSet(scheduleMealSetDetailID, name) {
		var r = confirm('Bạn muốn xóa thực đơn [' + name + '] ?');
		if (r == true) {
			$.ajax({
				url: '/Schedule/RemoveScheduleMealSet',
				tranditional: true,
				data: { scheduleMealSetDetailID: scheduleMealSetDetailID },
				async: false,
				success: function (result) {
					if (result == 'error') {
						alert('Có lỗi khi thêm thực đơn.');
						return false;
					}

					if (result.result == 'done') {
						location.reload(false);
					}
				}
			});
		}
	}

	function setCheckBoxEvent() {
		var $cb = $('#cbIsDayOn');

		$cb.change(function () {
			var isActive = true;
			var scheduleID = '@ViewBag.scheduleID';

			if ($cb.is(':checked')) {
			}
			else {
				var rowCount = $('#schedule-meal-set-table tbody').children('tr').length;
				var r = confirm('Nếu bạn đặt buổi này là buổi nghỉ\n'
					+ 'hệ thống sẽ tự động xóa hết thực đơn đang có dành cho nó.');
				if (r == true) {
					isActive = false;
				}
				else {
					$cb.prop('checked', true);
					return;
				}
			}

			$.ajax({
				url: '/Schedule/SetIsDayOn',
				tranditional: true,
				data: { isDayOn: isActive, scheduleID: scheduleID },
				async: false,
				success: function (result) {
					if (result == 'error') {
						alert('Có lỗi khi đặt lịch nghỉ.');
						return false;
					}

					if (result.result == 'done') {
						location.reload(false);
					}
				}
			})
		});
	}
</script>

<div class="container" style="background-color: #fff;box-shadow: 0px 0px 7px rgba(0, 0, 0, 0.5);border-radius: 7px;">
	<legend class="table-title">Cập nhật lịch ăn</legend>
	<div>
		<div class="table-body">
			Hoạt động : @Html.CheckBox("cbIsDayOn", isDayOn)
			<div id="meal-set-table-div">
				<table style="width: 100%; border: 1px solid black" id="schedule-meal-set-table">
					<tr>
						<td width="5%">Mã</td>
						<td width="20%">Tên thực đơn</td>
						<td width="25%">Ảnh minh họa</td>
						<td width="40%">Mô tả</td>
						<td width="10%"></td>
					</tr>
					@{
						char ch = 'A';
					}
					@foreach (System.Data.DataRow row in Model.Rows)
					{
						if (string.IsNullOrWhiteSpace(row["MealSetID"].ToString()))
						{
							continue;
						}
						<tr>
							<td>@ch.ToString()</td>
							<td>@row["Name"] </td>
							<td>
								@if (string.IsNullOrEmpty(row["Image"].ToString()))
								{
									<img src="~/Images/no-image.jpg" height="150px" width="150px">

								}
								else
								{
									<img src="..@row["Image"]" height="150px" width="150px">
								}
							</td>
							<td>@row["Description"]</td>
							<td><button class="btn btn-danger" title="Xóa" onclick="removeMealSet(@row["ScheduleMealSetDetailID"], '@row["Name"]')"><span class="glyphicon glyphicon-remove-sign"></span></button></td>
						</tr>
								ch += (char)1;
					}
				</table>
			</div>

			<div id="add-meal-set-table-div">
				<select id="meal-set-ddl" style="float: left"></select> <div id="add-meal-set-btn" onclick="addScheduleMealSet()"><a class="btn btn-primary">Thêm vào lịch</a></div>
			</div>
		</div>
	</div>
</div>
